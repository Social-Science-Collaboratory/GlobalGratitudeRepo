---
title: "Figure 1: Cross-cultural Visualization"
author: "Nicholas A. Coles, Annabel V. Dang"
description: "Visualizes cross-cultural data, generating Figure 1 for the manuscript"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Load packages
```{r}
# Install packages
source("setup.R")
```

# Open cross-cultural values
```{r}
# Fetch cross-cultural data
DF <-
  read.csv(here(
    "data/final-data",
    "crossculturalmod.csv"
  ))

# Standardize variables
DF <-
  DF %>%
  mutate(dist.us = if_else(country == "United States" & is.na(dist.us),
    0,
    dist.us
  )) %>%
  mutate_at(
    .vars = vars(
      dist.us,
      relational_mobility:indulgence
    ),
    ~ scales::rescale(., to = c(-1, 1))
  )
```

# Create figure 1a (cultural distance)
```{r}
# Create figure 1a
fig.1a <-
  ggplot(
    data = DF,
    aes(
      x = dist.us,
      y = .2
    )
  ) +

  # population density (all countries)
  geom_density(
    data = DF,
    aes(
      x = dist.us,
      y = ..scaled..
    ),
    color = "grey80",
    alpha = 0.5
  ) +

  # sample density (sampled countries)
  geom_density(
    data = DF %>%
      filter(sample == "yes"),
    aes(
      x = dist.us,
      y = ..scaled..
    ),
    color = "#3C5488",
    alpha = 0.5
  ) +

  # rug lines: unsampled countries
  geom_linerange(
    data = DF %>% filter(sample == "no"),
    aes(ymin = 0, ymax = 0.1),
    color = "grey50"
  ) +

  # rug lines: sampled countries
  geom_linerange(
    data = DF %>% filter(sample == "yes"),
    aes(
      ymin = 0, ymax = 0.2,
      color = country
    )
  ) +

  # country labels
  geom_text(
    data = DF %>% filter(sample == "yes"),
    aes(
      label = country,
      color = country,
      y = 1
    ),
    position = position_jitter(height = .75)
  ) +
  
  # theme
  theme_classic() +
  theme(
    legend.position = "none",
    axis.title.y = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.line.y = element_blank(),
    strip.background = element_blank()
  ) +
  xlab("Cultural distance (from USA)") +
  
  # Grey line for "All countries"
  geom_segment(
    aes(x = .6, xend = .75, 
        y = 1, yend = 1),
    color = "grey80",
    size = 1.5,
    inherit.aes = FALSE
  ) +
  geom_text(
    aes(x = .8, y = 1, label = "All countries"),
    hjust = 0,
    inherit.aes = FALSE
  ) +

  # Blue line for "Sampled countries"
  geom_segment(
    aes(x = .6, xend = .75, 
        y = .9, yend = .9),
    color = "#3C5488",
    size = 1.5,
    inherit.aes = FALSE
  ) +
  geom_text(
    aes(x = .8, y = .9,
        label = "Sampled countries"),
    hjust = 0,
    inherit.aes = FALSE
  ) +
  
  geom_rect(
    aes(xmin = .55, xmax = 1.05,
        ymin = .8, ymax = 1.1),
    color = "black",   
    fill = NA,         
    size = 1,        
    inherit.aes = FALSE
  )

fig.1a
```

# Map facet
```{r}
# Download world data
world <- ne_countries(
  scale = "medium",
  returnclass = "sf"
)

# Fix missing ISO values in world data
world[world$name == "France", ]$iso_a3 <- "FRA"
world[world$name == "Norway", ]$iso_a3 <- "NOR"
```

#Create figure 1b
```{r}
# Filter sampled countries
sampled_iso <- DF %>%
  filter(sample == "yes") %>%
  pull(iso)

# Get world map
world <- ne_countries(
  scale = "medium",
  returnclass = "sf"
)

# Create fig.1b
fig.1b <- ggplot() +
  # Base world map (all countries, no fill)
  layer_spatial(
    data = world,
    color = NA
  ) +

  # Highlight sampled countries
  layer_spatial(
    data = world %>% filter(iso_a3 %in% sampled_iso),
    aes(fill = iso_a3)
  ) +

  # Use equal-area projection
  coord_sf(crs = "ESRI:54030") +

  # Minimal theme, remove legend and axes
  theme_void() +  # removes axes, gridlines, and background
  theme(legend.position = "none")
```

# Create figure 1c (cross-cultural moderators)
```{r}
# Rename columns
fig1.DF <-
  DF %>%
  pivot_longer(relational_mobility:indulgence) %>%
  mutate(
    name =
      fct_recode(name,
        "Relational mobility" = "relational_mobility",
        "Responsibilism" = "responsibilism",
        "Tightness" = "tightness",
        "Religiosity" = "relig_mean",
        "GDP" = "mean_GDP",
        "Residential mobility" = "resmobility",
        "Power distance" = "power.distance",
        "Individualism" = "individualism",
        "Motivation" = "motivation",
        "Uncertainty avoidance" = "uncertainty.avoidance",
        "Long term orientation" = "long.term.orientation",
        "Indulgence" = "indulgence"
      )
  )
```

```{r}
# Create figure 1c
fig.1c <-
  ggplot(
    data = fig1.DF,
    aes(x = value)
  ) +

  # facet wrap
  facet_wrap(~name,
    scales = "free",
    strip.position = "bottom"
  ) +

  # plot all countries
  geom_density(
    alpha = .5,
    color = "grey70"
  ) +

  # plot sampled countries
  geom_density(
    data = fig1.DF %>%
      filter(sample == "yes"),
    alpha = .5,
    color = "#3C5488"
  ) +
  theme_classic() +
  theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.line.y = element_blank(),
    strip.placement = "outside",
    strip.background = element_blank()
  )
```

# Combine
```{r}
bc <-
  plot_grid(fig.1b,
    fig.1c,
    ncol = 2,
    labels = c("b", "c")
  )

plot_grid(fig.1a,
  bc,
  nrow = 2,
  labels = c("a", "")
)
```


