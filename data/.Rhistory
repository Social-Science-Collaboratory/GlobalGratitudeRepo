filter(consent == 1,
Progress > 95,
DistributionChannel == "anonymous",
brother >= 1 | sister >= 1)
#Fix mistake in Prolific, participants from Mexico were incorrectly marked as from Kenya
target_ids <- c(
"5bdf91dbb32fa800012ea282", "5d8e622ac42e4e0019530ec6", "67e5992d6dc49d614db50645",
"5f573b18a6a8b51a94fdbd08", "601857c3c3f5ce0c3e5fb913", "5ef2aa5c7700a611f5f47de8",
"6113113ee1e4e6df85ec7e8a", "5b11d226e9270900013c3029", "60d0c85826ef72e1f37e5fda",
"5ea90bb434d5e337e98c7edd", "65de63090d4695de8df8f28a", "613aa332f2b5896d8dcfa643",
"5d7957036797da0019537ad1", "6047b38939f7610352261d47", "5ef930974bc6e0000848aff7",
"5d9f84ebb9f68200173e3c58", "659ef44d5b498dc1ad4cab04", "5d3fcbef55efbe001592c0b6",
"5b5fdd52b36c3400014718b9", "6067f370472020b9dc5cf71b", "61145b698b354d688c2af144",
"6820d23a35383edba1be310a", "614f7d1a2eef4c845cbc7845", "5e8fd165f3d8212cd90e0d4d",
"5f4520ebb012170878012efc", "613a996383fe819b7cb48941", "67da488436f9ec390284e999",
"60b7afcc714c4aea063e8054", "5c90617326e3ed00019896a5", "653ec70763f99a4e8bfb0192",
"5e8b962507f0e10761c0e36d", "5e792d23c826500d4c0ccec0", "5f9afa6dffa5e21329cf3f6e",
"65831b61359b808abaac0271", "675b5d7a4d40431854b2cfce", "65ab079fde17d72bca5e774b",
"611824e4d4bcdddf6838ec12", "65c946a203b1a88740b02e52", "5e18cc8f30626119a3998c31",
"6822787de6f1107336b0120b", "616f22b8e54926da850c38c9", "6562817c7b17879c11207222",
"5c77a6b12819ab0016b94d47", "5f88a2f32c535806aefae159", "673d08b2d041957d61149f82",
"672d8afb609e47bf134e0b8d", "66311bae532a469f4858933e", "616dc07e0c53ae5752bc2b2c",
"64763d7569ad79a3ca9e29f1", "613a469755c08ab3b9d682ad"
)
# Update the lab column
DF <- DF %>%
mutate(lab = ifelse(PROLIFIC_PID %in% target_ids & lab == "KEN", "MEX", lab))
Prolific_df <- DF %>%
filter(!is.na(PROLIFIC_PID)) %>%
arrange(PROLIFIC_PID, RecordedDate) %>%
group_by(PROLIFIC_PID) %>%
slice(1) %>%
ungroup()
BeSample_df <- DF %>%
filter(modality == "BeSample")
combined_df <- bind_rows(Prolific_df, BeSample_df)
##
table_by_lab <- table(combined_df$lab)
print(table_by_lab)
print(table_by_lab)
table_by_lab <- table(combined_df$lab)
# Dangs API credential at UCSD
qualtrics_api_credentials(
api_key = 'urh7PtWEEOkAzrbjmYQC2FoipCvCT4n8ZIByL5rH',
base_url = 'iad1.qualtrics.com',
install = TRUE,
overwrite = TRUE)
library(dplyr)
library(here)
library(qualtRics)
# Dangs API credential at UCSD
qualtrics_api_credentials(
api_key = 'urh7PtWEEOkAzrbjmYQC2FoipCvCT4n8ZIByL5rH',
base_url = 'iad1.qualtrics.com',
install = TRUE,
overwrite = TRUE)
readRenviron("~/.Renviron")
# fetch survey
df <- fetch_survey(surveyID = 'SV_8hSc8K35mRJU646',
force_request = T,
label = F,
convert = F)
DF <- df %>%
filter(consent == 1,
Progress > 95,
DistributionChannel == "anonymous",
brother >= 1 | sister >= 1)
#Fix mistake in Prolific, participants from Mexico were incorrectly marked as from Kenya
target_ids <- c(
"5bdf91dbb32fa800012ea282", "5d8e622ac42e4e0019530ec6", "67e5992d6dc49d614db50645",
"5f573b18a6a8b51a94fdbd08", "601857c3c3f5ce0c3e5fb913", "5ef2aa5c7700a611f5f47de8",
"6113113ee1e4e6df85ec7e8a", "5b11d226e9270900013c3029", "60d0c85826ef72e1f37e5fda",
"5ea90bb434d5e337e98c7edd", "65de63090d4695de8df8f28a", "613aa332f2b5896d8dcfa643",
"5d7957036797da0019537ad1", "6047b38939f7610352261d47", "5ef930974bc6e0000848aff7",
"5d9f84ebb9f68200173e3c58", "659ef44d5b498dc1ad4cab04", "5d3fcbef55efbe001592c0b6",
"5b5fdd52b36c3400014718b9", "6067f370472020b9dc5cf71b", "61145b698b354d688c2af144",
"6820d23a35383edba1be310a", "614f7d1a2eef4c845cbc7845", "5e8fd165f3d8212cd90e0d4d",
"5f4520ebb012170878012efc", "613a996383fe819b7cb48941", "67da488436f9ec390284e999",
"60b7afcc714c4aea063e8054", "5c90617326e3ed00019896a5", "653ec70763f99a4e8bfb0192",
"5e8b962507f0e10761c0e36d", "5e792d23c826500d4c0ccec0", "5f9afa6dffa5e21329cf3f6e",
"65831b61359b808abaac0271", "675b5d7a4d40431854b2cfce", "65ab079fde17d72bca5e774b",
"611824e4d4bcdddf6838ec12", "65c946a203b1a88740b02e52", "5e18cc8f30626119a3998c31",
"6822787de6f1107336b0120b", "616f22b8e54926da850c38c9", "6562817c7b17879c11207222",
"5c77a6b12819ab0016b94d47", "5f88a2f32c535806aefae159", "673d08b2d041957d61149f82",
"672d8afb609e47bf134e0b8d", "66311bae532a469f4858933e", "616dc07e0c53ae5752bc2b2c",
"64763d7569ad79a3ca9e29f1", "613a469755c08ab3b9d682ad"
)
# Update the lab column
DF <- DF %>%
mutate(lab = ifelse(PROLIFIC_PID %in% target_ids & lab == "KEN", "MEX", lab))
Prolific_df <- DF %>%
filter(!is.na(PROLIFIC_PID)) %>%
arrange(PROLIFIC_PID, RecordedDate) %>%
group_by(PROLIFIC_PID) %>%
slice(1) %>%
ungroup()
BeSample_df <- DF %>%
filter(modality == "BeSample")
combined_df <- bind_rows(Prolific_df, BeSample_df)
##
table_by_lab <- table(combined_df$lab)
print(table_by_lab)
library(dplyr)
library(here)
library(qualtRics)
# Dangs API credential at UCSD
qualtrics_api_credentials(
api_key = 'urh7PtWEEOkAzrbjmYQC2FoipCvCT4n8ZIByL5rH',
base_url = 'iad1.qualtrics.com',
install = TRUE,
overwrite = TRUE)
readRenviron("~/.Renviron")
# fetch survey
df <- fetch_survey(surveyID = 'SV_8hSc8K35mRJU646',
force_request = T,
label = F,
convert = F)
DF <- df %>%
filter(consent == 1,
Progress > 95,
DistributionChannel == "anonymous",
brother >= 1 | sister >= 1)
#Fix mistake in Prolific, participants from Mexico were incorrectly marked as from Kenya
target_ids <- c(
"5bdf91dbb32fa800012ea282", "5d8e622ac42e4e0019530ec6", "67e5992d6dc49d614db50645",
"5f573b18a6a8b51a94fdbd08", "601857c3c3f5ce0c3e5fb913", "5ef2aa5c7700a611f5f47de8",
"6113113ee1e4e6df85ec7e8a", "5b11d226e9270900013c3029", "60d0c85826ef72e1f37e5fda",
"5ea90bb434d5e337e98c7edd", "65de63090d4695de8df8f28a", "613aa332f2b5896d8dcfa643",
"5d7957036797da0019537ad1", "6047b38939f7610352261d47", "5ef930974bc6e0000848aff7",
"5d9f84ebb9f68200173e3c58", "659ef44d5b498dc1ad4cab04", "5d3fcbef55efbe001592c0b6",
"5b5fdd52b36c3400014718b9", "6067f370472020b9dc5cf71b", "61145b698b354d688c2af144",
"6820d23a35383edba1be310a", "614f7d1a2eef4c845cbc7845", "5e8fd165f3d8212cd90e0d4d",
"5f4520ebb012170878012efc", "613a996383fe819b7cb48941", "67da488436f9ec390284e999",
"60b7afcc714c4aea063e8054", "5c90617326e3ed00019896a5", "653ec70763f99a4e8bfb0192",
"5e8b962507f0e10761c0e36d", "5e792d23c826500d4c0ccec0", "5f9afa6dffa5e21329cf3f6e",
"65831b61359b808abaac0271", "675b5d7a4d40431854b2cfce", "65ab079fde17d72bca5e774b",
"611824e4d4bcdddf6838ec12", "65c946a203b1a88740b02e52", "5e18cc8f30626119a3998c31",
"6822787de6f1107336b0120b", "616f22b8e54926da850c38c9", "6562817c7b17879c11207222",
"5c77a6b12819ab0016b94d47", "5f88a2f32c535806aefae159", "673d08b2d041957d61149f82",
"672d8afb609e47bf134e0b8d", "66311bae532a469f4858933e", "616dc07e0c53ae5752bc2b2c",
"64763d7569ad79a3ca9e29f1", "613a469755c08ab3b9d682ad"
)
# Update the lab column
DF <- DF %>%
mutate(lab = ifelse(PROLIFIC_PID %in% target_ids & lab == "KEN", "MEX", lab))
Prolific_df <- DF %>%
filter(!is.na(PROLIFIC_PID)) %>%
arrange(PROLIFIC_PID, RecordedDate) %>%
group_by(PROLIFIC_PID) %>%
slice(1) %>%
ungroup()
BeSample_df <- DF %>%
filter(modality == "BeSample")
combined_df <- bind_rows(Prolific_df, BeSample_df)
table_by_lab <- table(combined_df$lab)
print(table_by_lab)
library(tidyverse)
library(here)
library(countrycode)
library(cowplot)
library(ggplot2)
library(dplyr)
options(scipen = 999)
i_am('code/Figure1.Rmd')
library(tidyverse)
library(metafor)
library(ggExtra)
library(ggplot2)
library(ggrepel)
library(cowplot)
library(purrr)
library (here)
library(tidyverse)
library(metafor)
library(ggExtra)
library(ggplot2)
library(ggrepel)
library(cowplot)
library(purrr)
library (here)
# open data
# specify directory
i_am("code/Figure2.Rmd")
country.DF <-
# open data
read.csv(here('data',
'unique_country_effect_sizes.csv'
)
) %>%
# select relevant outcomes
select(
pa_effect_size,
na_effect_size,
optimistic_effect_size,
ls_effect_size,
envy_effect_size,
indebted_effect_size,
country) %>%
# summarise
group_by(country) %>%
summarise(across(everything(), mean, na.rm = TRUE))
i_am('code/Figure1.Rmd')
i_am("code/GlobalGratitude_CrossCulturalMods.R")
i_am("code/GlobalGratitude_CrossCulturalMods.R")
library(here)
setwd("~/GitHub/GlobalGratitudeRepo/data")
df <- read_csv("unique_country_effect_sizes.csv")
df <- df %>% select(country:ss_var)
# List of effect size columns and variance columns
effect_size_columns <- c("pa_effect_size", "na_effect_size",
"optimistic_effect_size","ls_effect_size",
"envy_effect_size", "indebted_effect_size")
variance_columns <- c("pa_var", "na_var", "optimistic_var",
"ls_var", "envy_var", "indebted_var")
# estimate total heterogeneity
m <- lapply(1:length(effect_size_columns), function(i) {
rma.mv(yi = df[[effect_size_columns[i]]],
V = df[[variance_columns[i]]],
data = df)})
#Calculate I2
calc_I2_from_model <- function(model) {
Q <- model$QE
df <- model$k - model$p
# I^2 formula
I2 <- if (Q <= df) 0 else ((Q - df) / Q) * 100
return(round(I2, 1))
}
m.c  <- lapply(1:length(effect_size_columns), function(i) {
rma.mv(yi = df[[effect_size_columns[i]]],
V = df[[variance_columns[i]]],
random = ~ 1 | country,
data = df)})
m.i  <- lapply(1:length(effect_size_columns), function(i) {
rma.mv(yi = df[[effect_size_columns[i]]],
V = df[[variance_columns[i]]],
random = ~ 1 | intervention_condition,
data = df)})
# Use lapply to fit models for each pair of effect size and variance (use this for results, annabel)
m.ic <- lapply(1:length(effect_size_columns), function(i) {
rma.mv(yi = df[[effect_size_columns[i]]],
V = df[[variance_columns[i]]],
random = list(~ 1 | intervention_condition, ~ 1 | country),
data = df)})
# Store the results with a name reflecting the effect size and variance pair
names(m.ic) <- paste(effect_size_columns)
# Apply to each model in your list
I2_list <- sapply(m.ic, calc_I2_from_model)
# Assign names
names(I2_list) <- effect_size_columns
# evaluate relative importance of variance components for each outcome
lapply(m.ic, function(model){
model$sigma2[2] / model$sigma2[1]})
#Confidence Intervals
# Loop through each effect size column and get confidence intervals
ci_list <- list()  # initialize a list to store the CIs
for (col in effect_size_columns) {
# Apply confint() to each model in the list
ci_list[[col]] <- confint(m.ic[[col]])
}
# Apply the operations for each effect size column
d.c <- lapply(effect_size_columns, function(effect_size) {
d.c <- df %>%
group_by(country) %>%
summarise(m = mean(.data[[effect_size]]), .groups = "drop") %>%
# add [jittered] y-value to assist with plotting
mutate(y = 0,
y = jitter(y, .1)) %>%
# labels most extreme observations (in terms of min and max)
mutate(label = if_else(m == min(m),
true = country,
false = ""),
label = if_else(m == max(m),
true = country,
false = label)) %>%
# include effect size name for reference
mutate(effect_size = effect_size)
return(d.c)
})
d.i <- lapply(effect_size_columns, function(effect_size) {
d.i <- df %>%
group_by(intervention_condition) %>%
summarise(m = mean(.data[[effect_size]]), .groups = "drop") %>%
# add [jittered] y-value to assist with plotting
mutate(y = -0.02,
y = jitter(y, .1)) %>%
# labels most extreme observations (in terms of min and max)
mutate(label = if_else(m == min(m),
true = intervention_condition,
false = ""),
label = if_else(m == max(m),
true = intervention_condition,
false = label)) %>%
# include effect size name for reference
mutate(effect_size = effect_size)
return(d.i)
})
d.c <- bind_rows(d.c)
d.i <- bind_rows(d.i)
# Create a list of ggplot objects
m.d <- lapply(seq_along(effect_size_columns), function(i) {
effect_size <- effect_size_columns[i]
model <- m.ic[[i]]
#Add tau
tau_label <- tau_df$tau_ci[i]
tau_str <- if (tau_label > 50) ">50" else round(tau_label, 2)
# Create label
label_text <- if (i == 1) {
paste0("τ(country)/τ(intervention) = ", tau_str)
} else {
paste0("= ", tau_str)
}
# Create the plot for each effect size
plot <- ggplot() +
# overall effect size estimate
geom_point(aes(x = model$b[1],
y = 5.7),
shape = 18,
size = 4,
color = "grey30") +
# 95% CI of overall effect size estimate
geom_segment(aes(x = model$ci.lb,
xend = model$ci.ub,
y = 5.7,
yend = 5.7),
color = "grey30") +
# visual indicator: null effect
geom_vline(xintercept = 0,
color = "grey30",
linetype = 'dotted') +
# density plot: intervention-level sources of heterogeneity
stat_function(fun = dnorm,
args = list(mean = model$b[1],
sd = sqrt(model$sigma2[1])),
color = "#E64B35") +
# density plot: country-level sources of heterogeneity
stat_function(fun = dnorm,
args = list(mean = model$b[1],
sd = sqrt(model$sigma2[2])),
color = "#3C5488") +
# Add tau_ci label
geom_text(aes(x = 0.7, y = 11.5, label = label_text),
color = "black", hjust = 1, vjust = 1, size = 4) +
# Aesthetics
scale_x_continuous(limits = c(-0.75, 0.75)) +
scale_y_continuous(limits = c(0, 12)) +
theme_void()
# ggtitle(effect_size) +
# theme(plot.title = element_text(hjust = 0.5,
#                                 face = "bold",
#                                 size = 12,
#                                 margin = margin(b = 4)
#                                 )
#       )
return(plot)
})
# Extract tau values
tau_c <- sapply(m.ic, function(model) (model$sigma2[2]))
tau_i <- sapply(m.ic, function(model) (model$sigma2[1]))
# Create data frame
tau_df <- data.frame(
effect_size = effect_size_columns,
tau_c = tau_c,
tau_i = tau_i,
tau_ci = tau_c / tau_i
)
options(scipen=999)
View(tau_df)
# Create a list of ggplot objects
m.d <- lapply(seq_along(effect_size_columns), function(i) {
effect_size <- effect_size_columns[i]
model <- m.ic[[i]]
#Add tau
tau_label <- tau_df$tau_ci[i]
tau_str <- if (tau_label > 50) ">50" else round(tau_label, 2)
# Create label
label_text <- if (i == 1) {
paste0("τ(country)/τ(intervention) = ", tau_str)
} else {
paste0("= ", tau_str)
}
# Create the plot for each effect size
plot <- ggplot() +
# overall effect size estimate
geom_point(aes(x = model$b[1],
y = 5.7),
shape = 18,
size = 4,
color = "grey30") +
# 95% CI of overall effect size estimate
geom_segment(aes(x = model$ci.lb,
xend = model$ci.ub,
y = 5.7,
yend = 5.7),
color = "grey30") +
# visual indicator: null effect
geom_vline(xintercept = 0,
color = "grey30",
linetype = 'dotted') +
# density plot: intervention-level sources of heterogeneity
stat_function(fun = dnorm,
args = list(mean = model$b[1],
sd = sqrt(model$sigma2[1])),
color = "#E64B35") +
# density plot: country-level sources of heterogeneity
stat_function(fun = dnorm,
args = list(mean = model$b[1],
sd = sqrt(model$sigma2[2])),
color = "#3C5488") +
# Add tau_ci label
geom_text(aes(x = 0.7, y = 11.5, label = label_text),
color = "black", hjust = 1, vjust = 1, size = 4) +
# Aesthetics
scale_x_continuous(limits = c(-0.75, 0.75)) +
scale_y_continuous(limits = c(0, 12)) +
theme_void()
# ggtitle(effect_size) +
# theme(plot.title = element_text(hjust = 0.5,
#                                 face = "bold",
#                                 size = 12,
#                                 margin = margin(b = 4)
#                                 )
#       )
return(plot)
})
# Check the resulting list of plots
m.d
# Combine both datasets into one data frame
d.c$dataset <- "d.c"
d.i$dataset <- "d.i"
d.c$intervention_condition <- NA
d.i$country <- NA
d.c.i <- rbind(d.c, d.i)
# clean labels
d.c.i <- d.c.i %>%
mutate(label = case_when(
label == "god.letter" ~ "divine\ngrat",
label == "hk.list"    ~ "naikan",
label == "sub"        ~ "mental\nsub",
TRUE ~ label
)
)
# Create a list of 6 plots based on the effect size values
m.p <- lapply(effect_size_columns, function(es) {
# Filter the data for the current effect_size level
data_subset <- subset(d.c.i, effect_size == es)
# Create the plot for the current effect_size
ggplot(data_subset) +
# visual indicator: null effect
geom_vline(xintercept = 0,
color = "grey30",
linetype = 'dotted') +
# Add country-level descriptives (for d.c)
geom_point(data = subset(data_subset, dataset == "d.c"),
aes(x = m, y = y),
color = "#3C5488", alpha = .5) +
# Add labels for country-level
geom_text_repel(data = subset(data_subset, dataset == "d.c"),
aes(x = m, y = y, label = label),
color = "#3C5488", alpha = .5, nudge_y = -.005) +
# Add intervention-level descriptives (for d.i)
geom_point(data = subset(data_subset, dataset == "d.i"),
aes(x = m, y = y),
color = "#E64B35", alpha = .5) +
# Add labels for intervention-level
geom_text_repel(data = subset(data_subset, dataset == "d.i"),
aes(x = m, y = y, label = label),
color = "#E64B35", alpha = .5, nudge_y = .005) +
# Aesthetics
theme_classic() +
theme(axis.title.y = element_blank(),
axis.title.x = element_blank(),
axis.text.y = element_blank(),
axis.ticks.y = element_blank()) +
scale_x_continuous(limits = c(-3, 3))
#labs(x = expression("Cohens " * italic('d')))
})
# Check the resulting list of plots
m.p
# Combine m.d and m.p into a single list
combined_plots <- mapply(function(plot_d, plot_p) {
# Combine each pair of plots (one from m.d and one from m.p) into a list
plot_grid(plot_d, plot_p, ncol = 1, rel_heights = c(.5, 1))
}, m.d, m.p, SIMPLIFY = FALSE)
# combine the plot
grid <-
plot_grid(combined_plots[[1]],
combined_plots[[2]],
combined_plots[[3]],
combined_plots[[4]],
combined_plots[[5]],
combined_plots[[6]],
ncol = 2,
labels = paste0("   ",
LETTERS[1:6],
". ",
c('Positive affect',
'Negative affect',
'Optimism',
'Life satisfaction',
'Envy',
'Indebtedness')
),
label_size = 10,
label_x = 0,
hjust = 0,
vjust = 1.7
)
# add space at bottom
ggdraw() +
draw_plot(grid, 0, 0.05, 1, 0.95) +
draw_label(expression("Cohen's "*italic(d)),
x = 0.5, y = 0, vjust = -1, size = 10)
