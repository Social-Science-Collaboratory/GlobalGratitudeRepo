<<<<<<< Updated upstream
<<<<<<< Updated upstream
qc.m.ic <- lapply(1:length(effect_size_columns), function(i) {
rma.mv(
yi = QC_unique_country_results_df[[effect_size_columns[i]]],
V = QC_unique_country_results_df[[variance_columns[i]]],
random = list(~ 1 | intervention_condition, ~ 1 | country),
data = QC_unique_country_results_df
)
})
# fetch survey for english-only data
EN_DF <- readRDS(file = here("data/final-data", "globalgratitude_final_cleaned.Rds")) %>%
filter(UserLanguage == "EN")
# fetch survey for quality-check data
QC_DF <- readRDS(file = here("quality-checks/sensitivity-analyses", "QC_globalgratitude_final_cleaned.Rds"))
# list of effect size columns and variance columns
effect_size_columns <- c(
"pa_effect_size", "na_effect_size",
"optimistic_effect_size", "ls_effect_size",
"envy_effect_size", "indebted_effect_size"
)
variance_columns <- c(
"pa_var", "na_var", "optimistic_var",
"ls_var", "envy_var", "indebted_var"
)
# calculate scales
calc_scales <- function(data) {
data %>%
rowwise() %>%
mutate(
# gratitude
gratitude_mean = mean(c(grateful, appreciative, thankful), na.rm = TRUE),
# positive affect
pa_mean = mean(c(happy, satisfied, content, joyful, pleased), na.rm = TRUE),
# optimism
optimistic_mean = mean(c(optimistic, hopeful), na.rm = TRUE),
# negative affect
na_mean = mean(c(sad, depressed, anxious, nervous), na.rm = TRUE),
# indebtedness
indebted_mean = mean(c(indebted, obligated), na.rm = TRUE),
# envy
envy_mean = mean(c(envious, bitter, jealous), na.rm = TRUE),
# life satisfaction
ls_mean = mean(c(ls_1, ls_2, ls_3, ls_4, ls_5), na.rm = TRUE),
# sense of self
ss_mean = mean(c(self_image, self_image_circle), na.rm = TRUE)
) %>%
ungroup() %>%
drop_na(
gratitude_mean, pa_mean, optimistic_mean, na_mean,
indebted_mean, envy_mean, ls_mean, guilty, ladder, ss_mean
) %>%
mutate(country = case_when(
lab == "POL_01" ~ "Poland",
lab == "POL_02" ~ "Poland",
lab == "DNK_01" ~ "Denmark",
lab == "TUR_01" ~ "Turkey",
lab == "MYS_01" ~ "Malaysia",
lab == "USA_01" ~ "United States",
lab == "USA_02" ~ "United States",
lab == "USA_02b" ~ "United States",
lab == "USA_02c" ~ "United States",
lab == "NGA_01" ~ "Nigeria",
lab == "NGA_02" ~ "Nigeria",
lab == "CAN_01" ~ "Canada",
lab == "FRA_01" ~ "France",
lab == "AUS_01" ~ "Australia",
lab == "CHL_01" ~ "Chile",
lab == "DEU_01" ~ "Germany",
lab == "GRC_01" ~ "Greece",
lab == "HUN_01" ~ "Hungary",
lab == "ISR_01" ~ "Israel",
lab == "IRL_01" ~ "Ireland",
lab == "MEX_01" ~ "Mexico",
lab == "ITA_01" ~ "Italy",
lab == "PRT_01" ~ "Portugal",
lab == "BRA_01" ~ "Brazil",
lab == "NLD_01" ~ "Netherlands",
lab == "GBR_01" ~ "United Kingdom",
lab == "ESP_01" ~ "Spain",
lab == "ZAF_01" ~ "South Africa",
lab == "KOR_01" ~ "South Korea",
lab == "SWE_01" ~ "Sweden",
lab == "IND_01" ~ "India",
lab == "COL_01" ~ "Colombia",
lab == "CHN_01" ~ "China",
lab == "KAZ_01" ~ "Kazakhstan",
lab == "NOR_01" ~ "Norway",
lab == "JPN_01" ~ "Japan",
lab == "GHA_01" ~ "Ghana",
lab == "THA_01" ~ "Thailand",
lab == "MKD_01" ~ "Macedonia",
TRUE ~ NA_character_
)) %>%
filter(!is.na(country)) %>%
select(country, condition, condition_type, guilty, ladder, gratitude_mean:ss_mean) %>%
mutate(
# recode factors
condition = factor(condition, levels = c(
"measure", "events", "int.events",
"list", "letter", "text", "naikan", "mental.sub", "divine.grat"
)),
condition_type = factor(condition_type, levels = c("control", "intervention"))
)
}
# apply
EN_DF <- calc_scales(EN_DF)
View(QC_DF)
QC_DF <- calc_scales(QC_DF)
# fetch survey for english-only data
EN_DF <- readRDS(file = here("data/final-data", "globalgratitude_final_cleaned.Rds")) %>%
filter(UserLanguage == "EN")
# fetch survey for quality-check data
QC_DF <- readRDS(file = here("quality-checks/sensitivity-analyses", "QC_globalgratitude_final_cleaned.Rds"))
# list of effect size columns and variance columns
effect_size_columns <- c(
"pa_effect_size", "na_effect_size",
"optimistic_effect_size", "ls_effect_size",
"envy_effect_size", "indebted_effect_size"
)
variance_columns <- c(
"pa_var", "na_var", "optimistic_var",
"ls_var", "envy_var", "indebted_var"
)
# calculate scales
calc_scales <- function(data) {
data %>%
rowwise() %>%
mutate(
# gratitude
gratitude_mean = mean(c(grateful, appreciative, thankful), na.rm = TRUE),
# positive affect
pa_mean = mean(c(happy, satisfied, content, joyful, pleased), na.rm = TRUE),
# optimism
optimistic_mean = mean(c(optimistic, hopeful), na.rm = TRUE),
# negative affect
na_mean = mean(c(sad, depressed, anxious, nervous), na.rm = TRUE),
# indebtedness
indebted_mean = mean(c(indebted, obligated), na.rm = TRUE),
# envy
envy_mean = mean(c(envious, bitter, jealous), na.rm = TRUE),
# life satisfaction
ls_mean = mean(c(ls_1, ls_2, ls_3, ls_4, ls_5), na.rm = TRUE),
# sense of self
ss_mean = mean(c(self_image, self_image_circle), na.rm = TRUE)
) %>%
ungroup() %>%
drop_na(
gratitude_mean, pa_mean, optimistic_mean, na_mean,
indebted_mean, envy_mean, ls_mean, guilty, ladder, ss_mean
) %>%
mutate(country = case_when(
lab == "POL_01" ~ "Poland",
lab == "POL_02" ~ "Poland",
lab == "DNK_01" ~ "Denmark",
lab == "TUR_01" ~ "Turkey",
lab == "MYS_01" ~ "Malaysia",
lab == "USA_01" ~ "United States",
lab == "USA_02" ~ "United States",
lab == "USA_02b" ~ "United States",
lab == "USA_02c" ~ "United States",
lab == "NGA_01" ~ "Nigeria",
lab == "NGA_02" ~ "Nigeria",
lab == "CAN_01" ~ "Canada",
lab == "FRA_01" ~ "France",
lab == "AUS_01" ~ "Australia",
lab == "CHL_01" ~ "Chile",
lab == "DEU_01" ~ "Germany",
lab == "GRC_01" ~ "Greece",
lab == "HUN_01" ~ "Hungary",
lab == "ISR_01" ~ "Israel",
lab == "IRL_01" ~ "Ireland",
lab == "MEX_01" ~ "Mexico",
lab == "ITA_01" ~ "Italy",
lab == "PRT_01" ~ "Portugal",
lab == "BRA_01" ~ "Brazil",
lab == "NLD_01" ~ "Netherlands",
lab == "GBR_01" ~ "United Kingdom",
lab == "ESP_01" ~ "Spain",
lab == "ZAF_01" ~ "South Africa",
lab == "KOR_01" ~ "South Korea",
lab == "SWE_01" ~ "Sweden",
lab == "IND_01" ~ "India",
lab == "COL_01" ~ "Colombia",
lab == "CHN_01" ~ "China",
lab == "KAZ_01" ~ "Kazakhstan",
lab == "NOR_01" ~ "Norway",
lab == "JPN_01" ~ "Japan",
lab == "GHA_01" ~ "Ghana",
lab == "THA_01" ~ "Thailand",
lab == "MKD_01" ~ "Macedonia",
TRUE ~ NA_character_
)) %>%
filter(!is.na(country)) %>%
select(country, condition, condition_type, guilty, ladder, gratitude_mean:ss_mean) %>%
mutate(
# recode factors
condition = factor(condition, levels = c(
"measure", "events", "int.events",
"list", "letter", "text", "naikan", "mental.sub", "divine.grat"
)),
condition_type = factor(condition_type, levels = c("control", "intervention"))
)
}
# apply
EN_DF <- calc_scales(EN_DF)
QC_DF <- calc_scales(QC_DF)
View(EN_DF)
View(QC_DF)
# create lists
EN_unique_labs <- unique(EN_DF$country)
QC_unique_labs <- unique(QC_DF$country)
condition_names <- c("list", "letter", "text", "naikan", "mental.sub", "divine.grat")
variables <- c(
"pa_mean", "na_mean", "optimistic_mean", "ls_mean", "ladder",
"envy_mean", "indebted_mean", "gratitude_mean", "guilty", "ss_mean"
)
# Function to compute all effect sizes for a dataset
compute_all_effect_sizes <- function(data, unique_labs, variables) {
# single comparison
compute_effect_sizes <- function(lab_name, control_cond, intervention_cond) {
country_data <- data %>% filter(country == lab_name)
control_subset <- country_data %>% filter(condition == control_cond)
intervention_subset <- country_data %>% filter(condition == intervention_cond)
# calculate variance
calc_var <- function(d, n1, n2) {
se_d <- sqrt((n1 + n2) / (n1 * n2) + d^2 / (2 * (n1 + n2)))
return(se_d^2)
}
# loop through each measure
effects <- sapply(variables, function(measure) {
d_result <- effsize::cohen.d(
intervention_subset[[measure]],
control_subset[[measure]],
pooled = TRUE,
hedges.correction = TRUE
)
d_value <- d_result$estimate
var_value <- calc_var(d_value, nrow(control_subset), nrow(intervention_subset))
c(d_value, var_value)
})
# split into vectors
effect_sizes <- effects[1, ]
variances <- effects[2, ]
# create result
result <- data.frame(
country = lab_name,
control_condition = control_cond,
intervention_condition = intervention_cond,
contrast = paste(control_cond, "vs", intervention_cond),
as.list(setNames(effect_sizes, paste0(gsub("_mean", "", variables), "_effect_size"))),
as.list(setNames(variances, paste0(gsub("_mean", "", variables), "_var"))),
stringsAsFactors = FALSE
)
return(result)
}
# loop through countries and contrasts
results_list <- list()
for (lab_name in unique_labs) {
country_data <- data %>% filter(country == lab_name)
control_conditions <- unique(country_data$condition[country_data$condition_type == "control"])
intervention_conditions <- unique(country_data$condition[country_data$condition_type == "intervention"])
for (control_cond in control_conditions) {
for (intervention_cond in intervention_conditions) {
results_list[[length(results_list) + 1]] <- compute_effect_sizes(lab_name, control_cond, intervention_cond)
}
}
}
# combine all results
results_df <- do.call(rbind, results_list)
return(results_df)
}
# Run for both datasets
EN_unique_country_results_df <- compute_all_effect_sizes(EN_DF, EN_unique_labs, variables)
EN_unique_country_results_df <- EN_unique_country_results_df %>%
filter(!is.na(intervention_condition), !is.na(country))
QC_unique_country_results_df <- compute_all_effect_sizes(QC_DF, QC_unique_labs, variables)
QC_unique_country_results_df <- QC_unique_country_results_df %>%
filter(!is.na(intervention_condition), !is.na(country))
# fit models for each pair of effect size and variance
en.m.ic <- lapply(1:length(effect_size_columns), function(i) {
rma.mv(
yi = EN_unique_country_results_df[[effect_size_columns[i]]],
V = EN_unique_country_results_df[[variance_columns[i]]],
random = list(~ 1 | intervention_condition, ~ 1 | country),
data = EN_unique_country_results_df
)
})
# store the results
names(en.m.ic) <- paste(effect_size_columns)
# evaluate variance components for each outcome
lapply(en.m.ic, function(model) {
model$sigma2[2] / model$sigma2[1]
})
# extract tau values
en_tau_c <- sapply(en.m.ic, function(model) (sqrt(model$sigma2[2])))
en_tau_p <- sapply(en.m.ic, function(model) (sqrt(model$sigma2[1])))
# fit models for each pair of effect size and variance
qc.m.ic <- lapply(1:length(effect_size_columns), function(i) {
rma.mv(
yi = QC_unique_country_results_df[[effect_size_columns[i]]],
V = QC_unique_country_results_df[[variance_columns[i]]],
random = list(~ 1 | intervention_condition, ~ 1 | country),
data = QC_unique_country_results_df
)
})
# store the results
names(qc.m.ic) <- paste(effect_size_columns)
# evaluate variance components for each outcome
lapply(qc.m.ic, function(model) {
model$sigma2[2] / model$sigma2[1]
})
# extract tau values
qc_tau_c <- sapply(qc.m.ic, function(model) (sqrt(model$sigma2[2])))
qc_tau_p <- sapply(qc.m.ic, function(model) (sqrt(model$sigma2[1])))
# open data
df <-
read.csv(file = here(
"data/output",
"unique_country_effect_sizes.csv"
)) %>%
select(country:ss_var)
# Use lapply to fit models for each pair of effect size and variance
m.ic <- lapply(1:length(effect_size_columns), function(i) {
rma.mv(
yi = df[[effect_size_columns[i]]],
V = df[[variance_columns[i]]],
random = list(~ 1 | intervention_condition, ~ 1 | country),
data = df
=======
letters_prefix <- letters[1:length(combined_plots)]
for (i in seq_along(combined_plots)) {
res <- results_df[i, ]
# Create expression for title
title_expr <- substitute(
letters[1:6] * ". " * outcome * "\n(" * italic(d) ~ "=" ~ est * ", 95% CI [" * lower * ", " * upper * "])",
list(
outcome = res$outcome,
est = round(res$estimate, 2),
lower = round(res$ci_lower, 2),
upper = round(res$ci_upper, 2)
)
)
=======
letters_prefix <- letters[1:length(combined_plots)]
for (i in seq_along(combined_plots)) {
res <- results_df[i, ]
# Create expression for title
title_expr <- substitute(
letters[1:6] * ". " * outcome * "\n(" * italic(d) ~ "=" ~ est * ", 95% CI [" * lower * ", " * upper * "])",
list(
outcome = res$outcome,
est = round(res$estimate, 2),
lower = round(res$ci_lower, 2),
upper = round(res$ci_upper, 2)
)
)
combined_plots[[i]] <- combined_plots[[i]] +
ggtitle(title_expr) +
theme(
plot.title = element_text(hjust = 0.5, size = 10, face = "bold") # smaller font, bold
)
}
# -------------------------------
# 1. Combine m.d and m.p per outcome
# -------------------------------
combined_plots <- mapply(function(plot_d, plot_p) {
plot_grid(plot_d, plot_p, ncol = 1, rel_heights = c(.5, 1))
}, m.d, m.p, SIMPLIFY = FALSE)
# -------------------------------
# 2. Assign titles with italic d + 95% CI using substitute()
# -------------------------------
for (i in seq_along(combined_plots)) {
res <- results_df[i, ]
# Create expression for title
title_expr <- substitute(
letters[1:6] * " . " * outcome * "\n(" * italic(d) ~ "=" ~ est * ", 95% CI [" * lower * ", " * upper * "])",
list(
outcome = res$outcome,
est = round(res$estimate, 2),
lower = round(res$ci_lower, 2),
upper = round(res$ci_upper, 2)
)
)
>>>>>>> Stashed changes
combined_plots[[i]] <- combined_plots[[i]] +
ggtitle(title_expr) +
theme(
plot.title = element_text(hjust = 0.5, size = 10, face = "bold") # smaller font, bold
<<<<<<< Updated upstream
)
}
# -------------------------------
# 1. Combine m.d and m.p per outcome
# -------------------------------
combined_plots <- mapply(function(plot_d, plot_p) {
plot_grid(plot_d, plot_p, ncol = 1, rel_heights = c(.5, 1))
}, m.d, m.p, SIMPLIFY = FALSE)
# -------------------------------
# 2. Assign titles with italic d + 95% CI using substitute()
# -------------------------------
for (i in seq_along(combined_plots)) {
res <- results_df[i, ]
# Create expression for title
title_expr <- substitute(
letters[1:6] * " . " * outcome * "\n(" * italic(d) ~ "=" ~ est * ", 95% CI [" * lower * ", " * upper * "])",
list(
outcome = res$outcome,
est = round(res$estimate, 2),
lower = round(res$ci_lower, 2),
upper = round(res$ci_upper, 2)
)
)
combined_plots[[i]] <- combined_plots[[i]] +
ggtitle(title_expr) +
theme(
plot.title = element_text(hjust = 0.5, size = 10, face = "bold") # smaller font, bold
>>>>>>> Stashed changes
)
}
# -------------------------------
# 3. Prepare tau labels
# -------------------------------
tau_labels <- sapply(tau_df$tau_ci, function(x) {
if (x > 50) "n.s." else paste0("= ", round(x, 2))
})
<<<<<<< Updated upstream
# Store the results with a name reflecting the effect size and variance pair
names(m.ic) <- paste(effect_size_columns)
# evaluate relative importance of variance components for each outcome
lapply(m.ic, function(model) {
model$sigma2[2] / model$sigma2[1]
})
# extract tau values
all_tau_c <- sapply(m.ic, function(model) (sqrt(model$sigma2[2])))
all_tau_p <- sapply(m.ic, function(model) (sqrt(model$sigma2[1])))
en_tau <- data.frame(
outcome = effect_size_columns,
tau_c = en_tau_c,
tau_p = en_tau_p,
tau_ci = en_tau_c / en_tau_p,
condition = "Excluding non-English surveys"
)
qc_tau <- data.frame(
outcome = effect_size_columns,
tau_c = qc_tau_c,
tau_p = qc_tau_p,
tau_ci = qc_tau_c / qc_tau_p,
condition = "Excluding potentially problematic participants"
)
all_tau <- data.frame(
outcome = effect_size_columns,
tau_c = all_tau_c,
tau_p = all_tau_p,
tau_ci = all_tau_c / all_tau_p,
condition = "Full"
)
tau_combined <- dplyr::bind_rows(all_tau, qc_tau, en_tau)
# effect size estimates for all data
results_df <- lapply(m.ic, function(model) {
est <- as.numeric(coef(model)) # pooled estimate (intercept)
se <- sqrt(diag(vcov(model)))[1] # SE of intercept
ci_lower <- est - 1.96 * se
ci_upper <- est + 1.96 * se
data.frame(
estimate = est,
ci_lower = ci_lower,
ci_upper = ci_upper
=======
>>>>>>> Stashed changes
)
}
# -------------------------------
# 3. Prepare tau labels
# -------------------------------
tau_labels <- sapply(tau_df$tau_ci, function(x) {
if (x > 50) "n.s." else paste0("= ", round(x, 2))
})
<<<<<<< Updated upstream
results_df <- do.call(rbind, results_df)
results_df$outcome <- names(m.ic)
results_df$condition <- "Full"
# effect size estimates for quality check data
en_results <- lapply(en.m.ic, function(model) {
est <- as.numeric(coef(model)) # pooled estimate (intercept)
se <- sqrt(diag(vcov(model)))[1] # SE of intercept
ci_lower <- est - 1.96 * se
ci_upper <- est + 1.96 * se
data.frame(
estimate = est,
ci_lower = ci_lower,
ci_upper = ci_upper
)
})
en_results_df <- do.call(rbind, en_results)
en_results_df$outcome <- names(en.m.ic)
en_results_df$condition <- "Excluding non-English surveys"
# effect size estimates for quality check data
qc_results <- lapply(qc.m.ic, function(model) {
est <- as.numeric(coef(model)) # pooled estimate (intercept)
se <- sqrt(diag(vcov(model)))[1] # SE of intercept
ci_lower <- est - 1.96 * se
ci_upper <- est + 1.96 * se
data.frame(
estimate = est,
ci_lower = ci_lower,
ci_upper = ci_upper
)
})
qc_results_df <- do.call(rbind, qc_results)
qc_results_df$outcome <- names(qc.m.ic)
qc_results_df$condition <- "Excluding potentially problematic participants"
# Bind them together
ef_combined <- dplyr::bind_rows(results_df, qc_results_df, en_results_df)
# Full sample
n_full <- "10,772"
# Excluding problematic participants
n_qc <- nrow(QC_DF)
# Excluding non-English surveys
n_en <- nrow(EN_DF)
# combine
combined_df <- ef_combined %>%
inner_join(tau_combined, by = c("outcome", "condition"))
apa_df <- combined_df %>%
dplyr::mutate(
# Format effect sizes and taus
estimate = sprintf("%.2f", estimate),
ci_lower = sprintf("%.2f", ci_lower),
ci_upper = sprintf("%.2f", ci_upper),
tau_c = sprintf("%.3f", tau_c),
tau_p = sprintf("%.3f", tau_p),
tau_ci = sprintf("%.2f", tau_ci),
# Remove leading zeros for APA
across(
c(estimate, ci_lower, ci_upper, tau_c, tau_p, tau_ci),
~ sub("^0", "", .x)
),
# Create CI column
CI = paste0("[", ci_lower, ", ", ci_upper, "]"),
# Add sample size per condition
n = dplyr::case_when(
condition == "Full" ~ n_full,
condition == "Excluding potentially problematic participants" ~ n_qc,
condition == "Excluding non-English surveys" ~ n_en
)
) %>%
dplyr::select(
Outcome = outcome,
Sample = condition,
n,
`Cohen's d` = estimate,
`95% CI` = CI,
τc = tau_c,
τp = tau_p,
`τc/τp` = tau_ci
)
# Full sample
n_full <- "10,772"
# Excluding problematic participants
n_qc <- nrow(QC_DF)
# Excluding non-English surveys
n_en <- nrow(EN_DF)
# Store counts as numeric
n_full <- 10772
n_qc   <- nrow(QC_DF)
n_en   <- nrow(EN_DF)
# Combine
combined_df <- ef_combined %>%
inner_join(tau_combined, by = c("outcome", "condition"))
apa_df <- combined_df %>%
dplyr::mutate(
# Format effect sizes and taus
estimate = sprintf("%.2f", estimate),
ci_lower = sprintf("%.2f", ci_lower),
ci_upper = sprintf("%.2f", ci_upper),
tau_c = sprintf("%.3f", tau_c),
tau_p = sprintf("%.3f", tau_p),
tau_ci = sprintf("%.2f", tau_ci),
# Remove leading zeros for APA
across(
c(estimate, ci_lower, ci_upper, tau_c, tau_p, tau_ci),
~ sub("^0", "", .x)
),
# Create CI column
CI = paste0("[", ci_lower, ", ", ci_upper, "]"),
# Add sample size per condition (still numeric here)
n = dplyr::case_when(
condition == "Full" ~ n_full,
condition == "Excluding potentially problematic participants" ~ n_qc,
condition == "Excluding non-English surveys" ~ n_en
),
# Format n nicely with commas for APA
n = format(n, big.mark = ",", scientific = FALSE)
) %>%
dplyr::select(
Outcome = outcome,
Sample = condition,
n,
`Cohen's d` = estimate,
`95% CI` = CI,
τc = tau_c,
τp = tau_p,
`τc/τp` = tau_ci
)
# Write to CSV
write_csv(apa_df, here("quality-checks", "sensitivity-analyses/si_table_4.csv"))
View(apa_df)
View(apa_df)
View(ef_combined)
View(tau_combined)
# Cross-cultural moderators
moderators <- read.csv(file = here("data/output", "moderators.csv"))
specific_rows <- moderators[c(36, 43, 64, 65), ]
tightness_rows <- moderators %>%
filter(moderator == "Tightness") %>%
slice(1:4)
moderators_selected <- bind_rows(specific_rows, tightness_rows) %>%
select(outcome:ci.upper)
print(moderators_selected)
=======
# -------------------------------
# 4. Build the grid
# -------------------------------
grid <- plot_grid(
combined_plots[[1]],
combined_plots[[2]],
combined_plots[[3]],
combined_plots[[4]],
combined_plots[[5]],
combined_plots[[6]],
ncol = 2
)
# -------------------------------
# 5. Draw final figure with annotations
# -------------------------------
ggdraw() +
draw_plot(grid, 0, 0.05, 1, 0.95) +
# Cohen's d label at bottom
draw_label(expression("Cohen's " * italic(d)),
x = 0.5, y = 0, vjust = -1, size = 10) +
# Tau numeric labels (positioned per panel)
draw_label(tau_labels[1], x = 0.08, y = 0.75, hjust = 0, size = 9) +
draw_label(tau_labels[2], x = 0.58, y = 0.75, hjust = 0, size = 9) +
draw_label(tau_labels[3], x = 0.08, y = 0.43, hjust = 0, size = 9) +
draw_label(tau_labels[4], x = 0.58, y = 0.43, hjust = 0, size = 9) +
draw_label(tau_labels[5], x = 0.08, y = 0.11, hjust = 0, size = 9) +
draw_label(tau_labels[6], x = 0.58, y = 0.11, hjust = 0, size = 9) +
# Tau headers for the first plot
draw_label(expression(tau[country]), x = 0.065, y = 0.77,
hjust = 1, vjust = 1, color = "#3C5488", size = 9) +
draw_label(expression(tau[practice]), x = 0.065, y = 0.748,
hjust = 1, vjust = 1, color = "#E64B35", size = 9) +
# Horizontal line under tau headers
draw_line(x = c(0.02, 0.07), y = c(0.75, 0.75),
color = "black", size = 0.5)
# -------------------------------
# 1. Combine m.d and m.p per outcome
# -------------------------------
combined_plots <- mapply(function(plot_d, plot_p) {
plot_grid(plot_d, plot_p, ncol = 1, rel_heights = c(.5, 1))
}, m.d, m.p, SIMPLIFY = FALSE)
# -------------------------------
# 2. Assign titles with italic d + 95% CI using substitute()
# -------------------------------
letters_prefix <- letters[1:length(combined_plots)]
for (i in seq_along(combined_plots)) {
res <- results_df[i, ]
# Create expression for title
title_expr <- substitute(
prefix * ". " * outcome * "\n(" * italic(d) ~ "=" ~ est * ", 95% CI [" * lower * ", " * upper * "])",
list(
prefix = letters_prefix[i],
outcome = res$outcome,
est = round(res$estimate, 2),
lower = round(res$ci_lower, 2),
upper = round(res$ci_upper, 2)
)
)
combined_plots[[i]] <- combined_plots[[i]] +
ggtitle(title_expr) +
theme(
plot.title = element_text(hjust = 0.5, size = 10, face = "bold") # smaller font, bold
)
}
# -------------------------------
# 3. Prepare tau labels
# -------------------------------
tau_labels <- sapply(tau_df$tau_ci, function(x) {
if (x > 50) "n.s." else paste0("= ", round(x, 2))
})
# -------------------------------
# 4. Build the grid
# -------------------------------
grid <- plot_grid(
combined_plots[[1]],
combined_plots[[2]],
combined_plots[[3]],
combined_plots[[4]],
combined_plots[[5]],
combined_plots[[6]],
ncol = 2
)
# -------------------------------
# 5. Draw final figure with annotations
# -------------------------------
ggdraw() +
draw_plot(grid, 0, 0.05, 1, 0.95) +
# Cohen's d label at bottom
draw_label(expression("Cohen's " * italic(d)),
x = 0.5, y = 0, vjust = -1, size = 10) +
# Tau numeric labels (positioned per panel)
draw_label(tau_labels[1], x = 0.08, y = 0.75, hjust = 0, size = 9) +
draw_label(tau_labels[2], x = 0.58, y = 0.75, hjust = 0, size = 9) +
draw_label(tau_labels[3], x = 0.08, y = 0.43, hjust = 0, size = 9) +
draw_label(tau_labels[4], x = 0.58, y = 0.43, hjust = 0, size = 9) +
draw_label(tau_labels[5], x = 0.08, y = 0.11, hjust = 0, size = 9) +
draw_label(tau_labels[6], x = 0.58, y = 0.11, hjust = 0, size = 9) +
# Tau headers for the first plot
draw_label(expression(tau[country]), x = 0.065, y = 0.77,
hjust = 1, vjust = 1, color = "#3C5488", size = 9) +
draw_label(expression(tau[practice]), x = 0.065, y = 0.748,
hjust = 1, vjust = 1, color = "#E64B35", size = 9) +
# Horizontal line under tau headers
draw_line(x = c(0.02, 0.07), y = c(0.75, 0.75),
color = "black", size = 0.5)
# -------------------------------
# 1. Combine m.d and m.p per outcome
# -------------------------------
combined_plots <- mapply(function(plot_d, plot_p) {
plot_grid(plot_d, plot_p, ncol = 1, rel_heights = c(.5, 1))
}, m.d, m.p, SIMPLIFY = FALSE)
# -------------------------------
# 2. Assign titles with italic d + 95% CI using substitute()
# -------------------------------
letters_prefix <- letters[1:length(combined_plots)]
for (i in seq_along(combined_plots)) {
res <- results_df[i, ]
# Create expression for title
title_expr <- substitute(
prefix * ". " * outcome * "\n(" * italic(d) ~ "=" ~ est * ", 95% CI [" * lower * ", " * upper * "])",
list(
prefix = letters_prefix[i],
outcome = res$outcome,
est = round(res$estimate, 2),
lower = round(res$ci_lower, 2),
upper = round(res$ci_upper, 2)
)
)
combined_plots[[i]] <- combined_plots[[i]] +
ggtitle(title_expr) +
theme(
plot.title = element_text(hjust = 0, face = "bold", size = 10) # left-aligned, bold
)
}
# -------------------------------
# 3. Prepare tau labels
# -------------------------------
tau_labels <- sapply(tau_df$tau_ci, function(x) {
if (x > 50) "n.s." else paste0("= ", round(x, 2))
})
# -------------------------------
# 4. Build the grid
# -------------------------------
grid <- plot_grid(
combined_plots[[1]],
combined_plots[[2]],
combined_plots[[3]],
combined_plots[[4]],
combined_plots[[5]],
combined_plots[[6]],
ncol = 2
)
# -------------------------------
# 5. Draw final figure with annotations
# -------------------------------
ggdraw() +
draw_plot(grid, 0, 0.05, 1, 0.95) +
# Cohen's d label at bottom
draw_label(expression("Cohen's " * italic(d)),
x = 0.5, y = 0, vjust = -1, size = 10) +
# Tau numeric labels (positioned per panel)
draw_label(tau_labels[1], x = 0.08, y = 0.75, hjust = 0, size = 9) +
draw_label(tau_labels[2], x = 0.58, y = 0.75, hjust = 0, size = 9) +
draw_label(tau_labels[3], x = 0.08, y = 0.43, hjust = 0, size = 9) +
draw_label(tau_labels[4], x = 0.58, y = 0.43, hjust = 0, size = 9) +
draw_label(tau_labels[5], x = 0.08, y = 0.11, hjust = 0, size = 9) +
draw_label(tau_labels[6], x = 0.58, y = 0.11, hjust = 0, size = 9) +
# Tau headers for the first plot
draw_label(expression(tau[country]), x = 0.065, y = 0.77,
hjust = 1, vjust = 1, color = "#3C5488", size = 9) +
draw_label(expression(tau[practice]), x = 0.065, y = 0.748,
hjust = 1, vjust = 1, color = "#E64B35", size = 9) +
# Horizontal line under tau headers
draw_line(x = c(0.02, 0.07), y = c(0.75, 0.75),
color = "black", size = 0.5)
# -------------------------------
# 1. Combine m.d and m.p per outcome
# -------------------------------
combined_plots <- mapply(function(plot_d, plot_p) {
plot_grid(plot_d, plot_p, ncol = 1, rel_heights = c(.5, 1))
}, m.d, m.p, SIMPLIFY = FALSE)
# -------------------------------
# 2. Assign titles with italic d + 95% CI using substitute()
# -------------------------------
letters_prefix <- letters[1:length(combined_plots)]
for (i in seq_along(combined_plots)) {
res <- results_df[i, ]
# Create expression for title
title_expr <- substitute(
"  " * prefix * ". " * outcome * " \n(" * italic(d) ~ "=" ~ est * ", 95% CI [" * lower * ", " * upper * "])",
list(
prefix = letters_prefix[i],
outcome = res$outcome,
est = round(res$estimate, 2),
lower = round(res$ci_lower, 2),
upper = round(res$ci_upper, 2)
)
)
combined_plots[[i]] <- combined_plots[[i]] +
ggtitle(
paste0(
"(", letters_prefix[i], ") <b>", res$outcome, "</b>\n",
"<i>d</i> = ", round(res$estimate,2),
", 95% CI [", round(res$ci_lower,2), ", ", round(res$ci_upper,2), "]"
)
) +
theme(
plot.title = element_markdown(hjust = 0, size = 10) # markdown allows bold/italic
)
# -------------------------------
# 3. Prepare tau labels
# -------------------------------
tau_labels <- sapply(tau_df$tau_ci, function(x) {
if (x > 50) "n.s." else paste0("= ", round(x, 2))
})
# -------------------------------
# 4. Build the grid
# -------------------------------
grid <- plot_grid(
combined_plots[[1]],
combined_plots[[2]],
combined_plots[[3]],
combined_plots[[4]],
combined_plots[[5]],
combined_plots[[6]],
ncol = 2
)
# -------------------------------
# 5. Draw final figure with annotations
# -------------------------------
ggdraw() +
draw_plot(grid, 0, 0.05, 1, 0.95) +
# Cohen's d label at bottom
draw_label(expression("Cohen's " * italic(d)),
x = 0.5, y = 0, vjust = -1, size = 10) +
# Tau numeric labels (positioned per panel)
draw_label(tau_labels[1], x = 0.08, y = 0.75, hjust = 0, size = 9) +
draw_label(tau_labels[2], x = 0.58, y = 0.75, hjust = 0, size = 9) +
draw_label(tau_labels[3], x = 0.08, y = 0.43, hjust = 0, size = 9) +
draw_label(tau_labels[4], x = 0.58, y = 0.43, hjust = 0, size = 9) +
draw_label(tau_labels[5], x = 0.08, y = 0.11, hjust = 0, size = 9) +
draw_label(tau_labels[6], x = 0.58, y = 0.11, hjust = 0, size = 9) +
# Tau headers for the first plot
draw_label(expression(tau[country]), x = 0.065, y = 0.77,
hjust = 1, vjust = 1, color = "#3C5488", size = 9) +
draw_label(expression(tau[practice]), x = 0.065, y = 0.748,
hjust = 1, vjust = 1, color = "#E64B35", size = 9) +
# Horizontal line under tau headers
draw_line(x = c(0.02, 0.07), y = c(0.75, 0.75),
color = "black", size = 0.5)
# -------------------------------
# 1. Combine m.d and m.p per outcome
# -------------------------------
combined_plots <- mapply(function(plot_d, plot_p) {
plot_grid(plot_d, plot_p, ncol = 1, rel_heights = c(.5, 1))
}, m.d, m.p, SIMPLIFY = FALSE)
# -------------------------------
# 2. Assign titles with italic d + 95% CI using substitute()
# -------------------------------
letters_prefix <- letters[1:length(combined_plots)]
for (i in seq_along(combined_plots)) {
res <- results_df[i, ]
# Create expression for title
title_expr <- substitute(
prefix * ". " * outcome * " \n(" * italic(d) ~ "=" ~ est * ", 95% CI [" * lower * ", " * upper * "])",
list(
prefix = letters_prefix[i],
outcome = res$outcome,
est = round(res$estimate, 2),
lower = round(res$ci_lower, 2),
upper = round(res$ci_upper, 2)
)
)
=======
# -------------------------------
# 4. Build the grid
# -------------------------------
grid <- plot_grid(
combined_plots[[1]],
combined_plots[[2]],
combined_plots[[3]],
combined_plots[[4]],
combined_plots[[5]],
combined_plots[[6]],
ncol = 2
)
# -------------------------------
# 5. Draw final figure with annotations
# -------------------------------
ggdraw() +
draw_plot(grid, 0, 0.05, 1, 0.95) +
# Cohen's d label at bottom
draw_label(expression("Cohen's " * italic(d)),
x = 0.5, y = 0, vjust = -1, size = 10) +
# Tau numeric labels (positioned per panel)
draw_label(tau_labels[1], x = 0.08, y = 0.75, hjust = 0, size = 9) +
draw_label(tau_labels[2], x = 0.58, y = 0.75, hjust = 0, size = 9) +
draw_label(tau_labels[3], x = 0.08, y = 0.43, hjust = 0, size = 9) +
draw_label(tau_labels[4], x = 0.58, y = 0.43, hjust = 0, size = 9) +
draw_label(tau_labels[5], x = 0.08, y = 0.11, hjust = 0, size = 9) +
draw_label(tau_labels[6], x = 0.58, y = 0.11, hjust = 0, size = 9) +
# Tau headers for the first plot
draw_label(expression(tau[country]), x = 0.065, y = 0.77,
hjust = 1, vjust = 1, color = "#3C5488", size = 9) +
draw_label(expression(tau[practice]), x = 0.065, y = 0.748,
hjust = 1, vjust = 1, color = "#E64B35", size = 9) +
# Horizontal line under tau headers
draw_line(x = c(0.02, 0.07), y = c(0.75, 0.75),
color = "black", size = 0.5)
# -------------------------------
# 1. Combine m.d and m.p per outcome
# -------------------------------
combined_plots <- mapply(function(plot_d, plot_p) {
plot_grid(plot_d, plot_p, ncol = 1, rel_heights = c(.5, 1))
}, m.d, m.p, SIMPLIFY = FALSE)
# -------------------------------
# 2. Assign titles with italic d + 95% CI using substitute()
# -------------------------------
letters_prefix <- letters[1:length(combined_plots)]
for (i in seq_along(combined_plots)) {
res <- results_df[i, ]
# Create expression for title
title_expr <- substitute(
prefix * ". " * outcome * "\n(" * italic(d) ~ "=" ~ est * ", 95% CI [" * lower * ", " * upper * "])",
list(
prefix = letters_prefix[i],
outcome = res$outcome,
est = round(res$estimate, 2),
lower = round(res$ci_lower, 2),
upper = round(res$ci_upper, 2)
)
)
combined_plots[[i]] <- combined_plots[[i]] +
ggtitle(title_expr) +
theme(
plot.title = element_text(hjust = 0.5, size = 10, face = "bold") # smaller font, bold
)
}
# -------------------------------
# 3. Prepare tau labels
# -------------------------------
tau_labels <- sapply(tau_df$tau_ci, function(x) {
if (x > 50) "n.s." else paste0("= ", round(x, 2))
})
# -------------------------------
# 4. Build the grid
# -------------------------------
grid <- plot_grid(
combined_plots[[1]],
combined_plots[[2]],
combined_plots[[3]],
combined_plots[[4]],
combined_plots[[5]],
combined_plots[[6]],
ncol = 2
)
# -------------------------------
# 5. Draw final figure with annotations
# -------------------------------
ggdraw() +
draw_plot(grid, 0, 0.05, 1, 0.95) +
# Cohen's d label at bottom
draw_label(expression("Cohen's " * italic(d)),
x = 0.5, y = 0, vjust = -1, size = 10) +
# Tau numeric labels (positioned per panel)
draw_label(tau_labels[1], x = 0.08, y = 0.75, hjust = 0, size = 9) +
draw_label(tau_labels[2], x = 0.58, y = 0.75, hjust = 0, size = 9) +
draw_label(tau_labels[3], x = 0.08, y = 0.43, hjust = 0, size = 9) +
draw_label(tau_labels[4], x = 0.58, y = 0.43, hjust = 0, size = 9) +
draw_label(tau_labels[5], x = 0.08, y = 0.11, hjust = 0, size = 9) +
draw_label(tau_labels[6], x = 0.58, y = 0.11, hjust = 0, size = 9) +
# Tau headers for the first plot
draw_label(expression(tau[country]), x = 0.065, y = 0.77,
hjust = 1, vjust = 1, color = "#3C5488", size = 9) +
draw_label(expression(tau[practice]), x = 0.065, y = 0.748,
hjust = 1, vjust = 1, color = "#E64B35", size = 9) +
# Horizontal line under tau headers
draw_line(x = c(0.02, 0.07), y = c(0.75, 0.75),
color = "black", size = 0.5)
# -------------------------------
# 1. Combine m.d and m.p per outcome
# -------------------------------
combined_plots <- mapply(function(plot_d, plot_p) {
plot_grid(plot_d, plot_p, ncol = 1, rel_heights = c(.5, 1))
}, m.d, m.p, SIMPLIFY = FALSE)
# -------------------------------
# 2. Assign titles with italic d + 95% CI using substitute()
# -------------------------------
letters_prefix <- letters[1:length(combined_plots)]
for (i in seq_along(combined_plots)) {
res <- results_df[i, ]
# Create expression for title
title_expr <- substitute(
prefix * ". " * outcome * "\n(" * italic(d) ~ "=" ~ est * ", 95% CI [" * lower * ", " * upper * "])",
list(
prefix = letters_prefix[i],
outcome = res$outcome,
est = round(res$estimate, 2),
lower = round(res$ci_lower, 2),
upper = round(res$ci_upper, 2)
)
)
combined_plots[[i]] <- combined_plots[[i]] +
ggtitle(title_expr) +
theme(
plot.title = element_text(hjust = 0, face = "bold", size = 10) # left-aligned, bold
)
}
# -------------------------------
# 3. Prepare tau labels
# -------------------------------
tau_labels <- sapply(tau_df$tau_ci, function(x) {
if (x > 50) "n.s." else paste0("= ", round(x, 2))
})
# -------------------------------
# 4. Build the grid
# -------------------------------
grid <- plot_grid(
combined_plots[[1]],
combined_plots[[2]],
combined_plots[[3]],
combined_plots[[4]],
combined_plots[[5]],
combined_plots[[6]],
ncol = 2
)
# -------------------------------
# 5. Draw final figure with annotations
# -------------------------------
ggdraw() +
draw_plot(grid, 0, 0.05, 1, 0.95) +
# Cohen's d label at bottom
draw_label(expression("Cohen's " * italic(d)),
x = 0.5, y = 0, vjust = -1, size = 10) +
# Tau numeric labels (positioned per panel)
draw_label(tau_labels[1], x = 0.08, y = 0.75, hjust = 0, size = 9) +
draw_label(tau_labels[2], x = 0.58, y = 0.75, hjust = 0, size = 9) +
draw_label(tau_labels[3], x = 0.08, y = 0.43, hjust = 0, size = 9) +
draw_label(tau_labels[4], x = 0.58, y = 0.43, hjust = 0, size = 9) +
draw_label(tau_labels[5], x = 0.08, y = 0.11, hjust = 0, size = 9) +
draw_label(tau_labels[6], x = 0.58, y = 0.11, hjust = 0, size = 9) +
# Tau headers for the first plot
draw_label(expression(tau[country]), x = 0.065, y = 0.77,
hjust = 1, vjust = 1, color = "#3C5488", size = 9) +
draw_label(expression(tau[practice]), x = 0.065, y = 0.748,
hjust = 1, vjust = 1, color = "#E64B35", size = 9) +
# Horizontal line under tau headers
draw_line(x = c(0.02, 0.07), y = c(0.75, 0.75),
color = "black", size = 0.5)
# -------------------------------
# 1. Combine m.d and m.p per outcome
# -------------------------------
combined_plots <- mapply(function(plot_d, plot_p) {
plot_grid(plot_d, plot_p, ncol = 1, rel_heights = c(.5, 1))
}, m.d, m.p, SIMPLIFY = FALSE)
# -------------------------------
# 2. Assign titles with italic d + 95% CI using substitute()
# -------------------------------
letters_prefix <- letters[1:length(combined_plots)]
for (i in seq_along(combined_plots)) {
res <- results_df[i, ]
# Create expression for title
title_expr <- substitute(
"  " * prefix * ". " * outcome * " \n(" * italic(d) ~ "=" ~ est * ", 95% CI [" * lower * ", " * upper * "])",
list(
prefix = letters_prefix[i],
outcome = res$outcome,
est = round(res$estimate, 2),
lower = round(res$ci_lower, 2),
upper = round(res$ci_upper, 2)
)
)
combined_plots[[i]] <- combined_plots[[i]] +
ggtitle(
paste0(
"(", letters_prefix[i], ") <b>", res$outcome, "</b>\n",
"<i>d</i> = ", round(res$estimate,2),
", 95% CI [", round(res$ci_lower,2), ", ", round(res$ci_upper,2), "]"
)
) +
theme(
plot.title = element_markdown(hjust = 0, size = 10) # markdown allows bold/italic
)
# -------------------------------
# 3. Prepare tau labels
# -------------------------------
tau_labels <- sapply(tau_df$tau_ci, function(x) {
if (x > 50) "n.s." else paste0("= ", round(x, 2))
})
# -------------------------------
# 4. Build the grid
# -------------------------------
grid <- plot_grid(
combined_plots[[1]],
combined_plots[[2]],
combined_plots[[3]],
combined_plots[[4]],
combined_plots[[5]],
combined_plots[[6]],
ncol = 2
)
# -------------------------------
# 5. Draw final figure with annotations
# -------------------------------
ggdraw() +
draw_plot(grid, 0, 0.05, 1, 0.95) +
# Cohen's d label at bottom
draw_label(expression("Cohen's " * italic(d)),
x = 0.5, y = 0, vjust = -1, size = 10) +
# Tau numeric labels (positioned per panel)
draw_label(tau_labels[1], x = 0.08, y = 0.75, hjust = 0, size = 9) +
draw_label(tau_labels[2], x = 0.58, y = 0.75, hjust = 0, size = 9) +
draw_label(tau_labels[3], x = 0.08, y = 0.43, hjust = 0, size = 9) +
draw_label(tau_labels[4], x = 0.58, y = 0.43, hjust = 0, size = 9) +
draw_label(tau_labels[5], x = 0.08, y = 0.11, hjust = 0, size = 9) +
draw_label(tau_labels[6], x = 0.58, y = 0.11, hjust = 0, size = 9) +
# Tau headers for the first plot
draw_label(expression(tau[country]), x = 0.065, y = 0.77,
hjust = 1, vjust = 1, color = "#3C5488", size = 9) +
draw_label(expression(tau[practice]), x = 0.065, y = 0.748,
hjust = 1, vjust = 1, color = "#E64B35", size = 9) +
# Horizontal line under tau headers
draw_line(x = c(0.02, 0.07), y = c(0.75, 0.75),
color = "black", size = 0.5)
# -------------------------------
# 1. Combine m.d and m.p per outcome
# -------------------------------
combined_plots <- mapply(function(plot_d, plot_p) {
plot_grid(plot_d, plot_p, ncol = 1, rel_heights = c(.5, 1))
}, m.d, m.p, SIMPLIFY = FALSE)
# -------------------------------
# 2. Assign titles with italic d + 95% CI using substitute()
# -------------------------------
letters_prefix <- letters[1:length(combined_plots)]
for (i in seq_along(combined_plots)) {
res <- results_df[i, ]
# Create expression for title
title_expr <- substitute(
prefix * ". " * outcome * " \n(" * italic(d) ~ "=" ~ est * ", 95% CI [" * lower * ", " * upper * "])",
list(
prefix = letters_prefix[i],
outcome = res$outcome,
est = round(res$estimate, 2),
lower = round(res$ci_lower, 2),
upper = round(res$ci_upper, 2)
)
)
combined_plots[[i]] <- combined_plots[[i]] +
ggtitle(title_expr) +
theme(
plot.title = element_text(hjust = 0.3, face = "bold", size = 10) # left-aligned, bold
)
}
# -------------------------------
# 3. Prepare tau labels
# -------------------------------
tau_labels <- sapply(tau_df$tau_ci, function(x) {
if (x > 50) "n.s." else paste0("= ", round(x, 2))
})
# -------------------------------
# 4. Build the grid
# -------------------------------
grid <- plot_grid(
combined_plots[[1]],
combined_plots[[2]],
combined_plots[[3]],
combined_plots[[4]],
combined_plots[[5]],
combined_plots[[6]],
ncol = 2
)
# -------------------------------
# 5. Draw final figure with annotations
# -------------------------------
ggdraw() +
draw_plot(grid, 0, 0.05, 1, 0.95) +
# Cohen's d label at bottom
draw_label(expression("Cohen's " * italic(d)),
x = 0.5, y = 0, vjust = -1, size = 10) +
# Tau numeric labels (positioned per panel)
draw_label(tau_labels[1], x = 0.08, y = 0.75, hjust = 0, size = 9) +
draw_label(tau_labels[2], x = 0.58, y = 0.75, hjust = 0, size = 9) +
draw_label(tau_labels[3], x = 0.08, y = 0.43, hjust = 0, size = 9) +
draw_label(tau_labels[4], x = 0.58, y = 0.43, hjust = 0, size = 9) +
draw_label(tau_labels[5], x = 0.08, y = 0.11, hjust = 0, size = 9) +
draw_label(tau_labels[6], x = 0.58, y = 0.11, hjust = 0, size = 9) +
# Tau headers for the first plot
draw_label(expression(tau[country]), x = 0.065, y = 0.77,
hjust = 1, vjust = 1, color = "#3C5488", size = 9) +
draw_label(expression(tau[practice]), x = 0.065, y = 0.748,
hjust = 1, vjust = 1, color = "#E64B35", size = 9) +
# Horizontal line under tau headers
draw_line(x = c(0.02, 0.07), y = c(0.75, 0.75),
color = "black", size = 0.5)
# -------------------------------
# 1. Combine m.d and m.p per outcome
# -------------------------------
combined_plots <- mapply(function(plot_d, plot_p) {
plot_grid(plot_d, plot_p, ncol = 1, rel_heights = c(.5, 1))
}, m.d, m.p, SIMPLIFY = FALSE)
# -------------------------------
# 2. Assign titles with italic d + 95% CI using substitute()
# -------------------------------
letters_prefix <- letters[1:length(combined_plots)]
for (i in seq_along(combined_plots)) {
res <- results_df[i, ]
# Create expression for title
title_expr <- substitute(
prefix * ". " * outcome * " \n(" * italic(d) ~ "=" ~ est * ", 95% CI [" * lower * ", " * upper * "])",
list(
prefix = letters_prefix[i],
outcome = res$outcome,
est = round(res$estimate, 2),
lower = round(res$ci_lower, 2),
upper = round(res$ci_upper, 2)
)
)
>>>>>>> Stashed changes
combined_plots[[i]] <- combined_plots[[i]] +
ggtitle(title_expr) +
theme(
plot.title = element_text(hjust = 0.3, face = "bold", size = 10) # left-aligned, bold
)
}
# -------------------------------
# 3. Prepare tau labels
# -------------------------------
tau_labels <- sapply(tau_df$tau_ci, function(x) {
if (x > 50) "n.s." else paste0("= ", round(x, 2))
})
# -------------------------------
# 4. Build the grid
# -------------------------------
grid <- plot_grid(
combined_plots[[1]],
combined_plots[[2]],
combined_plots[[3]],
combined_plots[[4]],
combined_plots[[5]],
combined_plots[[6]],
ncol = 2
)
# -------------------------------
# 5. Draw final figure with annotations
# -------------------------------
ggdraw() +
draw_plot(grid, 0, 0.05, 1, 0.95) +
# Cohen's d label at bottom
draw_label(expression("Cohen's " * italic(d)),
x = 0.5, y = 0, vjust = -1, size = 10) +
# Tau numeric labels (positioned per panel)
draw_label(tau_labels[1], x = 0.08, y = 0.75, hjust = 0, size = 9) +
draw_label(tau_labels[2], x = 0.58, y = 0.75, hjust = 0, size = 9) +
draw_label(tau_labels[3], x = 0.08, y = 0.43, hjust = 0, size = 9) +
draw_label(tau_labels[4], x = 0.58, y = 0.43, hjust = 0, size = 9) +
draw_label(tau_labels[5], x = 0.08, y = 0.11, hjust = 0, size = 9) +
draw_label(tau_labels[6], x = 0.58, y = 0.11, hjust = 0, size = 9) +
# Tau headers for the first plot
draw_label(expression(tau[country]), x = 0.065, y = 0.77,
hjust = 1, vjust = 1, color = "#3C5488", size = 9) +
draw_label(expression(tau[practice]), x = 0.065, y = 0.748,
hjust = 1, vjust = 1, color = "#E64B35", size = 9) +
# Horizontal line under tau headers
draw_line(x = c(0.02, 0.07), y = c(0.75, 0.75),
color = "black", size = 0.5)
# -------------------------------
# 1. Combine m.d and m.p per outcome
# -------------------------------
combined_plots <- mapply(function(plot_d, plot_p) {
plot_grid(plot_d, plot_p, ncol = 1, rel_heights = c(.5, 1))
}, m.d, m.p, SIMPLIFY = FALSE)
# -------------------------------
# 2. Assign titles with italic d + 95% CI using substitute()
# -------------------------------
letters_prefix <- letters[1:length(combined_plots)]
for (i in seq_along(combined_plots)) {
res <- results_df[i, ]
# Create expression for title
title_expr <- substitute(
prefix * ". " * outcome * " \n(" * italic(d) ~ "=" ~ est * ", 95% CI [" * lower * ", " * upper * "])",
list(
prefix = letters_prefix[i],
outcome = res$outcome,
est = round(res$estimate, 2),
lower = round(res$ci_lower, 2),
upper = round(res$ci_upper, 2)
)
)
combined_plots[[i]] <- combined_plots[[i]] +
ggtitle(title_expr) +
theme(
plot.title = element_text(hjust = 0.3, face = "bold", size = 10) # left-aligned, bold
)
}
# -------------------------------
# 3. Prepare tau labels
# -------------------------------
tau_labels <- sapply(tau_df$tau_ci, function(x) {
if (x > 50) "n.s." else paste0("= ", round(x, 2))
})
# -------------------------------
# 4. Build the grid
# -------------------------------
grid <- plot_grid(
combined_plots[[1]],
combined_plots[[2]],
combined_plots[[3]],
combined_plots[[4]],
combined_plots[[5]],
combined_plots[[6]],
ncol = 2
)
# -------------------------------
# 5. Draw final figure with annotations
# -------------------------------
ggdraw() +
draw_plot(grid, 0, 0.05, 1, 0.95) +
# Cohen's d label at bottom
draw_label(expression("Cohen's " * italic(d)),
x = 0.5, y = 0, vjust = -1, size = 10) +
# Tau numeric labels (positioned per panel)
draw_label(tau_labels[1], x = 0.08, y = 0.75, hjust = 0, size = 9) +
draw_label(tau_labels[2], x = 0.58, y = 0.75, hjust = 0, size = 9) +
draw_label(tau_labels[3], x = 0.08, y = 0.43, hjust = 0, size = 9) +
draw_label(tau_labels[4], x = 0.58, y = 0.43, hjust = 0, size = 9) +
draw_label(tau_labels[5], x = 0.08, y = 0.11, hjust = 0, size = 9) +
draw_label(tau_labels[6], x = 0.58, y = 0.11, hjust = 0, size = 9) +
# Tau headers for the first plot
draw_label(expression(tau[country]), x = 0.065, y = 0.77,
hjust = 1, vjust = 1, color = "#3C5488", size = 9) +
draw_label(expression(tau[practice]), x = 0.065, y = 0.748,
hjust = 1, vjust = 1, color = "#E64B35", size = 9) +
# Horizontal line under tau headers
draw_line(x = c(0.02, 0.07), y = c(0.75, 0.75),
color = "black", size = 0.5)
<<<<<<< Updated upstream
# -------------------------------
# 1. Combine m.d and m.p per outcome
# -------------------------------
combined_plots <- mapply(function(plot_d, plot_p) {
plot_grid(plot_d, plot_p, ncol = 1, rel_heights = c(.5, 1))
}, m.d, m.p, SIMPLIFY = FALSE)
# -------------------------------
# 2. Assign titles with italic d + 95% CI using substitute()
# -------------------------------
letters_prefix <- letters[1:length(combined_plots)]
for (i in seq_along(combined_plots)) {
res <- results_df[i, ]
# Create expression for title
title_expr <- substitute(
prefix * ". " * outcome * " \n(" * italic(d) ~ "=" ~ est * ", 95% CI [" * lower * ", " * upper * "])",
list(
prefix = letters_prefix[i],
outcome = res$outcome,
est = round(res$estimate, 2),
lower = round(res$ci_lower, 2),
upper = round(res$ci_upper, 2)
)
)
combined_plots[[i]] <- combined_plots[[i]] +
ggtitle(title_expr) +
theme(
plot.title = element_text(hjust = 0.3, face = "bold", size = 10) # left-aligned, bold
)
}
# -------------------------------
# 3. Prepare tau labels
# -------------------------------
tau_labels <- sapply(tau_df$tau_ci, function(x) {
if (x > 50) "n.s." else paste0("= ", round(x, 2))
})
# -------------------------------
# 4. Build the grid
# -------------------------------
grid <- plot_grid(
combined_plots[[1]],
combined_plots[[2]],
combined_plots[[3]],
combined_plots[[4]],
combined_plots[[5]],
combined_plots[[6]],
ncol = 2
)
# -------------------------------
# 5. Draw final figure with annotations
# -------------------------------
ggdraw() +
draw_plot(grid, 0, 0.05, 1, 0.95) +
# Cohen's d label at bottom
draw_label(expression("Cohen's " * italic(d)),
x = 0.5, y = 0, vjust = -1, size = 10) +
# Tau numeric labels (positioned per panel)
draw_label(tau_labels[1], x = 0.08, y = 0.75, hjust = 0, size = 9) +
draw_label(tau_labels[2], x = 0.58, y = 0.75, hjust = 0, size = 9) +
draw_label(tau_labels[3], x = 0.08, y = 0.43, hjust = 0, size = 9) +
draw_label(tau_labels[4], x = 0.58, y = 0.43, hjust = 0, size = 9) +
draw_label(tau_labels[5], x = 0.08, y = 0.11, hjust = 0, size = 9) +
draw_label(tau_labels[6], x = 0.58, y = 0.11, hjust = 0, size = 9) +
# Tau headers for the first plot
draw_label(expression(tau[country]), x = 0.065, y = 0.77,
hjust = 1, vjust = 1, color = "#3C5488", size = 9) +
draw_label(expression(tau[practice]), x = 0.065, y = 0.748,
hjust = 1, vjust = 1, color = "#E64B35", size = 9) +
# Horizontal line under tau headers
draw_line(x = c(0.02, 0.07), y = c(0.75, 0.75),
color = "black", size = 0.5)
>>>>>>> Stashed changes
=======
>>>>>>> Stashed changes
